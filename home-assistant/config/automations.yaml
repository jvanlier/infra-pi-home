- alias: Alert Dishwasher Done
  id: 'alert-dishwasher-done'
  trigger:
    - platform: numeric_state
      entity_id: sensor.dishwasher_power 
      above: 1000  # warming up
      for: '00:00:10'
  action:
    - wait_for_trigger:
        - platform: numeric_state
          entity_id: sensor.dishwasher_power 
          below: 1
          for: '00:00:05'
    - service: notify.notify
      data:
        title: Dishwasher
        message: Dishwasher done
  mode: restart

# The Dishwasher is a bit unreliable lately, and seems better if we power cycle
# it before the next wash cycle.
# Possible improvement: prolong time switched off (0.7 W standby consumption).
- alias: Power Cycle Dishwasher at night when idle
  id: "power-cycle-dishwasher"
  trigger:
    - platform: time
      at: '00:00:00'
  condition:
    - condition: state
      entity_id: switch.dishwasher
      state: "on"
  action:
    - wait_for_trigger:
      # Ensure it is actually turned off and not still drying
      - platform: numeric_state
        entity_id: sensor.dishwasher_power
        below: 1.2
        for: '01:00:00'
      timeout: '03:00:00'  # single cycle takes 2 hrs 45 mins
      continue_on_timeout: false
    - service: switch.turn_off
      target:
        entity_id: switch.dishwasher
    - delay: '03:00:00'  # worst case it turns back on @ 6
    - service: switch.turn_on
      target:
        entity_id: switch.dishwasher

