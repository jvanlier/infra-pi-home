- alias: Alert dishwasher done
  id: 'alert-dishwasher-done'
  trigger:
    - platform: state 
      entity_id: sensor.dishwasher_state
      from: 'drying'
      to: 'washing'  # not quite, pumping out water, but we don't have a state for that
      for: '00:00:30'
  action:
    - wait_for_trigger:
      - platform:  state
        entity_id: sensor.dishwasher_state
        to: 'off_closed'
        for: '00:00:30'
      timeout: '00:05:00'
      continue_on_timeout: false
    - service: notify.notify
      data:
        title: Dishwasher
        message: 'Dishwasher appears to be done.'
  mode: restart

- alias: Alert dishwasher stuck
  id: 'alert-dishwasher-stuck'
  trigger:
    - platform: state 
      entity_id: sensor.dishwasher_state
      from: 'heating'
      to: 'washing'
      for: '00:20:00'
  action:
    - wait_for_trigger:
      - platform:  state
        entity_id: sensor.dishwasher_state
        # Usually from washing to off_closed, but may sometimes briefly touch drying
        # due to smooting the power signal.
        to: 'off_closed'
        for: '00:05:00'
      timeout: '00:30:00'
      continue_on_timeout: false
    - service: notify.notify
      data:
        title: Dishwasher
        message: >
          Dishwasher appears to be in the failure mode where it skips the drying phase.
          Consider it done and expect wetter-than-usual contents.
  mode: restart

# The Dishwasher is a bit unreliable lately, and seems better if we power cycle it regularly.
- alias: Power cycle dishwasher at night when off
  id: 'power-cycle-dishwasher'
  trigger:
    - platform: time
      at: '04:00:00'  # Check quite late to minimize chance that it's running
  condition:
    - condition: and
      conditions:
        # may have turned if off manually, e.g. if on holiday. Leave off in that case. 
        - condition: state
          entity_id: switch.dishwasher
          state: 'on'
        - condition: state 
          entity_id: sensor.dishwasher_state
          state: 
            - 'off_open'
            - 'off_closed'
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.dishwasher
    - delay: '01:00:00'
    - service: switch.turn_on
      target:
        entity_id: switch.dishwasher
  mode: restart

