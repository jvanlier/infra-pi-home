blueprint:
  name: Hue Wall Switch (Z2M) - Adaptive Lighting
  description: >
    Implementation for Hue Wall Switch for Zigbee2MQTT with specific Adaptive Lighting (AL) support.

    Complements the Hue Tap Dial Adaptive Lighting blueprint.

    If the automation appears to be triggered twice in short succession: change the device mode to push in zigbee2mqtt.
  domain: automation

  input:
    controller:
      name: (Zigbee2MQTT) Controller Name
      description: The name of the device in Zigbee2MQTT
    base_topic:
      name: Root/Base mqtt topic from Zigbee2MQTT
      description: The Root/base topic as configured in Zigbee2MQTT
      default: zigbee2mqtt

    left_light_group_all:
      name: Single Zigbee group that contains all the lights.
      description: >
        Used for turning off.
        It's not used for turning on, because then Adaptive Lighting doesn't register it.
      selector:
        entity:
          domain: light
          multiple: false

    left_light_group_ambiance:
      name: Single Zigbee group that contains only the ambiance lights.
      description: >
        Used for turning off when color controls are disabled.
      default: []
      selector:
        entity:
          domain: light
          multiple: false

    left_light_entities_on:
      name: Light entities for the "on" switch (all).
      description: >
        Light entities for the "on" switch.
        Each of these must be in a Adaptive Lighting configuration.
        All of those Adaptive Lighting configurations must be listed under "switch_entities_adapt_brightness".

        We switch on using the configured entities, if we switch on via the zigbee group that has all lights,
        they don't get AL applied at turn on.
      selector:
        entity:
          domain: light

    left_light_entities_on_ambiance:
      name: Light entities for the "on" switch (ambiance only).
      description: >
        Ambiance light entities only, used when color controls are disabled.
      default: []
      selector:
        entity:
          domain: light

    left_switch_entities_adapt_brightness:
      name: Adaptive Lighting adapt brightness switch entities (all).
      description: >
        The adaptive lighting switches, in order to  adaptive brightness when dimming them via the zigbee group (which is not in AL config).
      selector:
        entity:
          domain: switch

    left_switch_entities_adapt_brightness_ambiance:
      name: Adaptive Lighting adapt brightness switch entities (ambiance only).
      description: >
        The adaptive lighting switches for ambiance lights only, used when color controls are disabled.
      default: []
      selector:
        entity:
          domain: switch

    input_boolean_color_controls_disabled:
      name: Input boolean to disable color light controls.
      description: >
        Optional. When this input boolean is "on", only ambiance lights will be controlled.
      default: []
      selector:
        entity:
          domain: input_boolean
          multiple: false

mode: restart

trigger_variables:
  base_topic: !input base_topic
  controller: !input controller

trigger:
  - platform: mqtt
    topic: "{{ base_topic ~ '/' ~ controller ~ '/action' }}"

condition:
  - condition: template
    value_template: "{{ trigger.payload in [
      'left_press',
    ] }}"
    # Not implemented: release, long press, right button.

action:
  - variables:
      controller: !input controller
      command: "{{ trigger.payload }}"
      left_light_group_all: !input left_light_group_all
      left_light_group_ambiance: !input left_light_group_ambiance
      input_boolean_color_controls_disabled: !input input_boolean_color_controls_disabled
      color_controls_disabled: >
        {{ input_boolean_color_controls_disabled != [] and is_state(input_boolean_color_controls_disabled, 'on') }}
      active_light_group: >
        {{ left_light_group_ambiance if color_controls_disabled and left_light_group_ambiance != [] else left_light_group_all }}
  - choose:
      - conditions: '{{ command == "left_press" and states(active_light_group) != "on" }}'
        sequence:
          - choose:
              - conditions: '{{ color_controls_disabled }}'
                sequence:
                  # Only control ambiance lights when color controls are disabled
                  - service: switch.turn_on
                    target:
                      entity_id: !input left_switch_entities_adapt_brightness_ambiance
                  - service: light.turn_on
                    target:
                      entity_id: !input left_light_entities_on_ambiance
            default:
              # Normal operation: control all lights
              - service: switch.turn_on
                target:
                  entity_id: !input left_switch_entities_adapt_brightness
              - service: light.turn_on
                target:
                  entity_id: !input left_light_entities_on
      - conditions: '{{ command == "left_press" and states(active_light_group) == "on" }}'
        sequence:
          - service: light.turn_off
            target:
              entity_id: '{{ active_light_group }}'
          - choose:
              - conditions: '{{ color_controls_disabled }}'
                sequence:
                  # Only control ambiance lights when color controls are disabled
                  - service: switch.turn_on
                    target:
                      entity_id: !input left_switch_entities_adapt_brightness_ambiance
            default:
              # Normal operation: control all lights
              - service: switch.turn_on
                target:
                  entity_id: !input left_switch_entities_adapt_brightness
