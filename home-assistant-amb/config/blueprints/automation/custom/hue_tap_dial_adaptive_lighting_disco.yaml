blueprint:
  name: Hue Tap Dial (Z2M) - Adaptive Lighting - disco
  description: >
    Implementation for Hue Tap Dial for Zigbee2MQTT with specific Adaptive Lighting (AL) support,
    and both manual and automatic color cycle (disco) on the color light group.

    Requirements:
    - 1 or more Zigbee groups for all ambiance lights, configured as light entity in AL
    - 1 Zigbee group for all color lights, configured as light entity in AL
    - 1 Zigbee group for _all_ lights (not configured in AL)
    - 1 input boolean for disco

    The _all_ group is used for switching all lights _off_ reliably and in sync, and for dimming.
    The _all_ group is not used for turning lights _on_, because that will not activate AL.

    N.b.: when dimming, adapt brightness gets disabled.

    Potential downside: different brightness levels can be configured for each group in the AL config.
    However, when dimming, they will all get the same brightness, so any difference is lost until AL is
    re-activated (using button 1).

    Disco features, meant for kids:
    - Button 2 is used to cycle through random colors after each press.
    - Button 4 activates disco (automatic random color cycle).

  domain: automation

  input:
    controller:
      name: (Zigbee2MQTT) Controller Name
      description: The name of the device in Zigbee2MQTT
    base_topic:
      name: Root/Base mqtt topic from Zigbee2MQTT
      description: The Root/base topic as configured in Zigbee2MQTT
      default: zigbee2mqtt
    brightness_max:
      name: Max brightness
      description: Maximum brightness for dimming, in case the max of 255 can become too bright under all circumstances.
      default: 255
      selector:
        number:
          min: 1
          max: 255
    brightness_step:
      name: Brightness step size
      description: Brightness step size
      default: 25
      selector:
        number:
          min: 1
          max: 50

    light_group_all:
      name: Single Zigbee group that contains all the lights.
      description: >
        Used for turning off and for dimming.
        It's not used for turning on, because then Adaptive Lighting doesn't register it.
      selector:
        entity:
          domain: light
          multiple: false

    light_group_ambiance:
      name: Single Zigbee group that contains only the ambiance lights.
      description: >
        Used for turning off and dimming when color controls are disabled.
      default: []
      selector:
        entity:
          domain: light
          multiple: false

    light_group_color:
      name: Single Zigbee group that contains all the color lights.
      description: >
        These are the lights used for the disco.
      selector:
        entity:
          domain: light
          multiple: false

    switch_entities_adaptive_lighting:
      name: Adaptive Lighting switch entities (all).
      description: >
        The adaptive lighting switches for all lights, used for turning on with service adaptive_lighting.apply.
      selector:
        entity:
          domain: switch

    switch_entities_adaptive_lighting_ambiance:
      name: Adaptive Lighting switch entities (ambiance only).
      description: >
        The adaptive lighting switches for ambiance lights only, used when color controls are disabled.
      default: []
      selector:
        entity:
          domain: switch

    switch_entities_adapt_brightness:
      name: Adaptive Lighting adapt brightness switch entities (all).
      description: >
        The adaptive lighting adapt brightness switches for all lights, in order to turn off adaptive brightness when dimming them
        via the _all_ zigbee group.
      selector:
        entity:
          domain: switch

    switch_entities_adapt_brightness_ambiance:
      name: Adaptive Lighting adapt brightness switch entities (ambiance only).
      description: >
        The adaptive lighting adapt brightness switches for ambiance lights only, used when color controls are disabled.
      default: []
      selector:
        entity:
          domain: switch

    input_boolean_disco:
      name: Input boolean for disco.
      description: >
        Input boolean for disco toggle.
      selector:
        entity:
          domain: input_boolean
          multiple: false

    input_boolean_color_controls_disabled:
      name: Input boolean to disable color light controls.
      description: >
        Optional. When this input boolean is "on", color light controls will be restricted:
        - Buttons 2 and 4 (color cycle and disco) will be completely disabled
        - Buttons 1 and 3 (AL on/off) and brightness controls will only affect ambiance lights
      default: []
      selector:
        entity:
          domain: input_boolean
          multiple: false

mode: restart

trigger_variables:
  base_topic: !input base_topic
  controller: !input controller

trigger:
  - platform: mqtt
    topic: "{{ base_topic ~ '/' ~ controller ~ '/action' }}"

# This condition is not strictly necessary, but it makes sure that the automation only triggers when there is a
# supported action. This makes for easier debugging etc.
condition:
  - condition: template
    value_template: "{{ trigger.payload in [
      'button_1_press',
      'button_2_press',
      'button_3_press',
      'button_4_press',
      'brightness_step_down',
      'brightness_step_up',
    ] }}"
    # Not implemented: press_release, hold, hold_release, dial_rotate_[left|right]_[slow|fast|step]

action:
  - variables:
      controller: !input controller
      command: "{{ trigger.payload }}"
      light_group_all: !input light_group_all
      light_group_ambiance: !input light_group_ambiance
      input_boolean_color_controls_disabled: !input input_boolean_color_controls_disabled
      color_controls_disabled: >
        {{ input_boolean_color_controls_disabled != [] and is_state(input_boolean_color_controls_disabled, 'on') }}
      active_light_group: >
        {{ light_group_ambiance if color_controls_disabled and light_group_ambiance != [] else light_group_all }}
      current_brightness: >
        {{ state_attr(active_light_group, 'brightness') | int(0) }}
      brightness_max: !input brightness_max
      brightness_step: !input brightness_step
  - choose:
      - conditions: '{{ command == "button_1_press" }}'
        sequence:
          # Turn off disco, in case it was running:
          - service: input_boolean.turn_off
            target:
              entity_id: !input input_boolean_disco
          - choose:
              - conditions: '{{ color_controls_disabled }}'
                sequence:
                  # Only control ambiance lights when color controls are disabled
                  - service: switch.turn_on
                    target:
                      entity_id: !input switch_entities_adapt_brightness_ambiance
                  - service: adaptive_lighting.apply
                    data:
                      entity_id: !input switch_entities_adaptive_lighting_ambiance
                      turn_on_lights: true
            default:
              # Normal operation: control all lights
              - service: switch.turn_on
                target:
                  entity_id: !input switch_entities_adapt_brightness
              - service: adaptive_lighting.apply
                data:
                  entity_id: !input switch_entities_adaptive_lighting
                  turn_on_lights: true
      - conditions: '{{ command == "button_3_press" }}'
        sequence:
          # Turn off disco, in case it was running:
          - service: input_boolean.turn_off
            target:
              entity_id: !input input_boolean_disco
          - service: light.turn_off
            target:
              entity_id: '{{ active_light_group }}'
          - choose:
              - conditions: '{{ color_controls_disabled }}'
                sequence:
                  # Only control ambiance lights when color controls are disabled
                  - service: switch.turn_on
                    target:
                      entity_id: !input switch_entities_adapt_brightness_ambiance
            default:
              # Normal operation: control all lights
              - service: switch.turn_on
                target:
                  entity_id: !input switch_entities_adapt_brightness
      - conditions: '{{ command == "brightness_step_down" }}'
        sequence:
          - choose:
              - conditions: '{{ color_controls_disabled }}'
                sequence:
                  # Only control ambiance lights when color controls are disabled
                  - service: switch.turn_off
                    target:
                      entity_id: !input switch_entities_adapt_brightness_ambiance
                  - service: light.turn_on
                    data:
                      transition: 1
                      brightness: "{{ max(current_brightness - brightness_step, 1) }}"
                    target:
                      entity_id: '{{ light_group_ambiance }}'
            default:
              # Normal operation: control all lights
              - service: switch.turn_off
                target:
                  entity_id: !input switch_entities_adapt_brightness
              - service: light.turn_on
                data:
                  transition: 1
                  brightness: "{{ max(current_brightness - brightness_step, 1) }}"
                target:
                  entity_id: !input light_group_all
      - conditions: '{{ command == "brightness_step_up" }}'
        sequence:
          - choose:
              - conditions: '{{ color_controls_disabled }}'
                sequence:
                  # Only control ambiance lights when color controls are disabled
                  - service: switch.turn_off
                    target:
                      entity_id: !input switch_entities_adapt_brightness_ambiance
                  - service: light.turn_on
                    data:
                      transition: 1
                      brightness: "{{ min(current_brightness + brightness_step, brightness_max) }}"
                    target:
                      entity_id: '{{ light_group_ambiance }}'
            default:
              # Normal operation: control all lights
              - service: switch.turn_off
                target:
                  entity_id: !input switch_entities_adapt_brightness
              - service: light.turn_on
                data:
                  transition: 1
                  brightness: "{{ min(current_brightness + brightness_step, brightness_max) }}"
                target:
                  entity_id: !input light_group_all
      - conditions: '{{ command == "button_2_press" }}'
        # Manual random color - disabled when color controls are disabled
        sequence:
          - condition: template
            value_template: '{{ not color_controls_disabled }}'
          # Turn off disco, in case it was running:
          - service: input_boolean.turn_off
            target:
              entity_id: !input input_boolean_disco
          - service: light.turn_on
            data:
              transition: 1
              rgb_color: ["{{ range(0, 255) | random }}", "{{ range(0, 255) | random  }}", "{{ range(0, 255) | random  }}"]
            target:
              entity_id: !input light_group_color
      - conditions: '{{ command == "button_4_press" }}'
        # Automatic disco - disabled when color controls are disabled
        sequence:
          - condition: template
            value_template: '{{ not color_controls_disabled }}'
          - service: input_boolean.toggle
            target:
              entity_id: !input input_boolean_disco
