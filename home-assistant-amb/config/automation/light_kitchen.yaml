- alias: Motion-activated Light Kitchen Middle
  id: mal-kitchen-middle
  use_blueprint:
    path: custom/light_motion_activated_dark_aware_script.yaml
    input:
      motion_entity: binary_sensor.motion_kitchen_occupancy
      device_no_motion_wait: number.motion_kitchen_detection_interval
      total_no_motion_wait: 300
      light_entity_id: light.light_group_kitchen_middle
      adaptive_light_entity: switch.adaptive_lighting_kitchen_middle
      dim_script: script.turn_on_light_kitchen_middle_dimmed

- alias: Motion-activated Light Kitchen Countertop
  id: mal-kitchen-countertop
  use_blueprint:
    path: custom/light_motion_activated_dark_aware_script.yaml
    input:
      motion_entity: binary_sensor.motion_kitchen_occupancy
      device_no_motion_wait: number.motion_kitchen_detection_interval
      total_no_motion_wait: 300
      light_entity_id: light.light_group_kitchen_countertop
      adaptive_light_entity: switch.adaptive_lighting_kitchen_countertop
      dim_script: script.turn_on_light_kitchen_countertop_dimmed

- alias: Light kitchen on to dimmed state
  id: light-kitchen-on-to-dimmed
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.sufficiently_dark_for_indoor_lights
        - binary_sensor.presence_ground_floor
      to: "on"
    - platform: state
      entity_id: input_boolean.sleep_mode
      to: "off"
  condition:
    - condition: state
      entity_id:
        - binary_sensor.sufficiently_dark_for_indoor_lights
        - binary_sensor.presence_ground_floor
      state: "on"
    - alias: "Only turn on if not in sleep mode (dimmed state is too bright)"
      condition: state
      entity_id: input_boolean.sleep_mode
      state: "off"
    - alias: "Only turn on if currently off"
      condition: state
      entity_id: &kitchen_lights
        - light.light_group_kitchen_middle
        - light.light_group_kitchen_countertop
      state: "off"
  action:
    # Potential improvement: transition in script is 5 sec, in this case 1 sec is more appropriate.
    - action: script.turn_on_light_kitchen_middle_dimmed
    - action: script.turn_on_light_kitchen_countertop_dimmed
  mode: restart

- alias: Light kitchen off when in dimmed state
  id: light-kitchen-off-when-in-dimmed-state
  description: >
    Turn off kitchen lights when no presence detected anymore, or it becomes sufficiently bright.

    The goal is to turn off lights that are in dimmed state, when that is no longer needed.
    Dimmed state assumed when lights are on but there is no motion-activated automation running.
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.sufficiently_dark_for_indoor_lights
        - binary_sensor.presence_ground_floor
      to: "off"
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: light.light_group_kitchen_middle
          state: "on"
        - condition: state
          entity_id: light.light_group_kitchen_countertop
          state: "on"
    - alias: "Ensure automation for middle not running (i.e. no motion detected)"
      condition: state
      entity_id: automation.motion_activated_light_kitchen_middle
      attribute: current
      state: 0
    - alias: "Ensure automation for countertop not running (i.e. no motion detected)"
      condition: state
      entity_id: automation.motion_activated_light_kitchen_countertop
      attribute: current
      state: 0
  action:
    - service: "light.turn_off"
      data:
        transition: 10
      target:
        entity_id: *kitchen_lights
  mode: restart
